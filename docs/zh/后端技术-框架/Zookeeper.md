## 1、Zookeeper 是什么？

**ZooKeeper** 是一个 Apache 开源的分布式应用程序协调服务，是一个典型的分布式数据一致性解决方案。

![](/images/Zookeeper/1.jpg)

设计目的是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的系统，并以一系列简单易用的原子操作提供给用户使用～

## 2、Zookeeper 有哪些特性？

##### 顺序一致性（SequentialConsistency）

同一个客户端提交的事务，ZooKeeper 将严格按照提交顺序执行。

##### 原子性（Atomicity）

事务要么“全部完成”或“全部未完成"。

##### 单一系统镜像（SingleSystemImage）

客户端连接到 ZooKeeper 集群的任意节点，获得到的数据视图都是相同的。

##### 可靠性（Reliability）

事务一旦完成，产生的状态变化将永久保留，直到其他事务进行覆盖。

##### 实时性（Timeliness）

事务一旦完成，客户端可以在限定的时间段内获得最新的数据。

## 3、Zookeeper 有哪些应用场景？

##### 1、分布式服务注册与订阅

在分布式环境中，为了保证高可用性，通常同一个应用或同一个服务的提供方都会部署多份，达到对等服务。而消费者就须要在这些对等的服务器中选择一个来执行相关的业务逻辑，比较典型的服务注册与订阅，如 Dubbo。

##### 2、分布式配置中心

发布与订阅模型，即所谓的配置中心，顾名思义就是发布者将数据发布到 ZooKeeper 节点上，供订阅者获取数据，实现配置信息的集中式管理和动态更新。

##### 3、命名服务

在分布式系统中，通过命名服务客户端应用能够根据指定名字来获取资源、服务地址和提供者等信息。

##### 4、分布式锁

这个主要得益于 ZooKeeper 为我们保证了数据的强一致性。

## 4、Zookeeper 在哪些技术中有用到？

举几个例子吧，如：Dubbo、Elastic Job、Kafka 等，Zookeeper 还是很有用武之地的。

### 5、Zookeeper 服务的默认 3 个端口是？

##### Zookeeper 中的默认 3 个端口：

2181：对客户端提供服务的端口

3888：选举 Leader 使用

2888：集群内的机器通讯使用（Leader 会监听此端口）

### 6、Zookeeper 客户端与服务端是什么连接？

Zookeeper 客户端与服务端之间的连接是**基于 TCP 长连接的方式**。

### 7、Zookeeper 中的会话是什么？

Zookeeper 中的会话指的是客户端和服务端保持会话。

客户端与服务器建立 TCP 长链接成功后，服务端会向客户端分配全局唯一的会话 ID，客户端的生命周期就开始了，服务器会定时进行会话超时检测，客户端通过向服务器发送心跳以保持有效的的会话。

当会话结束后，会话期间所创建的所有临时节点也会被删除。

### 8、Zookeeper 中的文件系统怎么理解？

ZooKeeper 中的命名空间就可以理解为 ZooKeeper 应用的文件系统，Zookeeper 为了保证高吞吐和低延迟，在内存中维护了树状的目录结构，和 Linux 不同的是，ZooKeeper 中没有目录和文件的区别，统一都叫做节点：znode，节点都可以设置一些关联的数据。

![](/images/Zookeeper/8.jpg)

根路径以／开头。

### 9、Zookeeper 支持哪些数据节点类型？

##### 1、持久节点节点

永久存在于 Zookeeper 中，除非手动删除。

##### 2、临时节点

临时节点的生命周期与客户端会话进行绑定，一旦客户端会话失效，这个客户端所创建的所有临时节点都会被删除。

##### 3、持久顺序节点

在持久节点的基础上增加了顺序特性，节点名后面会追加一个由父节点维护的自增整型数字。

##### 4、临时顺序节点

在临时节点的基础上增加了顺序属性，节点名后面会追加一个由父节点维护的自增整型数字。

## 10、Zookeeper 节点包含哪几部分信息？

每个节点由 3 个部分组成：

- **stat**：节点的状态信息，包括节点版本、权限控制列表等信息
- **data**：节点关联的数据
- **children**：节点下的子节点

## 11、Zookeeper 节点有哪些状态信息？

一个节点的状态信息如下：

| 参数           | 描述                                                          |
| -------------- | ------------------------------------------------------------- |
| cZxid          | 创建节点事务 ID                                               |
| ctime          | 创建节点时间                                                  |
| mZxid          | 节点最后修改事务 ID                                           |
| mtime          | 节点最后修改时间                                              |
| pZxid          | 子节点最后变更的事务 ID(指的是添加、删除子节点，修改内容不算) |
| cversion       | 子节点版本号，每次修改+1                                      |
| dataVersion    | 数据版本号，每次修改+1                                        |
| aclVersion     | 权限版本号，每次修改+1                                        |
| ephemeralOwner | 创建该临时节点的会话 ID，持久节点此属性值为：0                |
| datalength     | 该节点的数据长度                                              |
| numChildren    | 该节点下的直接子节点数量                                      |

## 12、Zookeeper 节点存储数据有没有限制？

Zookeeper 节点不能用于存放大量的数据，每个节点的存放数据上限为：**1M**

## 13、Zookeeper 节点数据存储在哪？

主要是存储在内存，Zookeeper 可以理解为一个内存数据库，内存数据库中存储了一份完整的数据，包括所有的节点、会话、事务日志。

## 14、Zookeeper 中的 Watcher 机制作用？

Zookeeper 客户端可以在指定节点上注册一个 Watcher 监听器，用于监听某个节点的变化，包括数据的修改及子节点的变更，当节点触发指定的事件时，Zookeeper 服务端会把相应的事件通知到监听的客户端上，客户端可以根据事件通知再做出相应的反应。

比如，一般有的公司用 Zookeeper 作为配置中心，客户端需要感知到服务端配置的变化时，就会用到这个特性。

## 15、Zookeeper 中的 Watcher 会通知几次？

Zookeeper 中的 watcher 机制是一次性通知，即一个 watcher 只会触发一次通知事件，watcher 触发完事件之后就被移除监视管理了。另外，当连接会话结束后相关的 watchers 也会被删除。

所以，如果需要多次监听节点变更通知，则需要在事件触发后再重新/反复注册。

## 16、Zookeeper 中的事务 ID 是什么？

ZooKeeper 事务 ID 是指：**ZXID**，Zookeeper 会给每个更新请求分配一个事务 ID，它是一个 64 位的数字，由 Leader 统一分配，全局唯一，不断递增，在一个节点的状态信息中可以查看到最新的事务 ID 信息。

## 17、Zookeeper 如何识别请求的先后顺序？

Zookeeper 是根据事务 ID 的大小进行先后顺序区分的，事务 ID 的大小体现了事务操作的先后顺序，如果 zxid2 大于 zxid1，则说明 zxid2 是在 zxid1 之后进行操作。

## 18、Zookeeper 权限模式有哪些？

有以下 4 种权限模式：

| 方案   | 描述                         |
| ------ | ---------------------------- |
| world  | 代表所有人都能访问 (默认)    |
| ip     | 使用客户端 IP 形式认证       |
| auth   | 代表已认证的用户             |
| digest | 使用"用户名：密码"的方式认证 |

## 19、Zookeeper 权限控制（ACL）怎么理解？

Zookeeper 中的权限控制是指：**ACL**（Access Control List）访问控制列表，用来控制节点的操作权限，使用`scheme:id:permission`的形式来标识，主要涵盖 3 个方面：

- 权限模式(scheme)
- 授权对象(id)
- 授予的权限(permission)

Zookeeper 中的权限控制是基于每个节点的，可以针对每个节点设置多个权限控制方案。

另外，子节点不会继承父节点的权限，比如：客户端可以没有权限访问节点/a，但可以有权限访问它的子节点/a/b

## 20、Zookeeper 权限控制命令有哪些？

有以下三个控制命令：

| 命令    | 描述          |
| ------- | ------------- |
| getAcl  | 读取 ACL 权限 |
| setAcl  | 设置 ACL 权限 |
| addauth | 添加认证用户  |

## 21、Zookeeper 有哪几种权限控制？

Zookeeper 定义了 5 种权限，这 5 种权限简写为：crwda

##### 1、 CREATE (c)

创建子节点权限

##### 2、READ (r)

读取节点数据及显示子节点列表权限

##### 3、WRITE (w)

写入节点数据权限

##### 4、DELETE (d)

删除子节点权限

##### 5、ADMIN (a)

设置节点访问控制列表权限

新创建的节点默认是所有用户都有所有 crwda 权限。

## 22、Zookeeper 数据快照有什么用？

Zookeeper 中的数据快照是用来记录 Zookeeper 服务器上某一时刻的全量内存数据内容。

## 23、Zookeeper 支持持久化吗？

Zookeeper 支持内存数据持久化到磁盘，服务器会定时向磁盘持久化所有快照数据，Zookeeper 服务启动时会通过磁盘事务日志和快照数据文件完整恢复到内存。

## 24、Zookeeper 常用的命令有哪些？

命令行工具的一些常用操作命令如下：

##### stat

使用 stat 命令来查看某个节点的状态信息：

> [zk: 127.0.0.1:2181(CONNECTED) 1] stat /1

##### ls

使用 Is 命令来查看某个目录包含的所有文件：

> [zk: 127.0.0.1:2181(CONNECTED) 1] 1s /1

##### ls2

使用 Is2 命令来查看某个目录包含的所有文件：

> [zk: 127.0.0.1:2181(CONNECTED) 1] 1s2 /1

与 Is 不同的是它查看到 time、version 等信息。

##### create

创建一个节点并设置初始内容：

> [zk: 127.0.0.1:2181(CONNECTED) 1] create /test "hello" 1

创建一个新的 znode 节点"test"以及与它关联的字符串

##### get

获取节点的数据：

> [zk: 127.0.0.1:2181(CONNECTED) 1] get /test1

##### set

修改节点的内容：

> [zk: 127.0.0.1:2181(cONNECTED) 1] set /test "ricky"1

##### delete

删除一个节点：

> [zk: 127.0.0.1:2181(CONNECTED) 1] delete /test1

##### quit

退出客户端

## 25、Zookeeper 服务器有哪几种角色？

##### 1、Leader (主)

- 事务请求的唯一调度和处理者，保证集群事务处理的顺序性
- 集群内部各服务的调度者

##### 2、Follower (从)

- 处理客户端的非事务请求，转发事务请求给 Leader 服务器
- 参与事务请求 Proposal 的投票
- 参与 Leader 选举投票

##### 3、Observer(观察者)

- 处理客户端的非事务请求，转发事务请求给 Leader 服务器
- 不参与任何形式的投票

## 26、Zookeeper 服务器有哪几种工作状态？

#### Zookeeper 服务器具有 4 种状态：

##### 1、LOOKING

寻找 Leader 状态，当服务器处于该状态时，表示当前集群没有 Leader，因此会进入 Leader 选举状态。

##### 2、FOLLOWING

跟随者状态，表示当前服务器角色是 Follower，参与投票。

##### 3、LEADING

领导者状态，表示当前服务器角色是 Leader。

##### 4、OBSERVING

观察者状态，表示当前服务器角色是 Observer，不参与投票。

## 27、ZookeeperLeader 要经历哪三个阶段？

##### 1、发现

Zookeeper 集群会选择出一个 Leader 进程。

##### 2、同步

Leader 需要将自己的数据与所有 follower 完成同步。

##### 3、广播

Leader 接受客户端新的 proposal 请求并广播给所有的 follower。

## 28、Zookeeper 有哪两种 Leader 选举场景？

##### Leader 选举有以下两种场景：

1）Zookeeper 集群启动初始化时进行选举

2）Zookeeper 集群 Leader 失联时重新选举

## 29、Zookeeper 有哪几种 Leader 选举方式？

Zookeeper 提供了 3 种选举方式：

##### 1、LeaderElection

LeaderElection 是 Fast Paxos 算法最简单的一种实现，每个 Server 启动以后，都会询问其它的 Server 都投票给谁，收到所有的 Server 答复以后，就计算出 zxid 最大的 Server，并将它设置为下一次要投票的 Server。

> 该算法已在 Zookeeper 3.4 中废弃了。

##### 2、FastLeaderElection(最新默认)

> FastLeaderElection 是 Zookeeper 默认的 Leader 选举算法。

具体流程参考：Zookeeper 启动时选举流程是怎样的？

##### 3、AuthFastLeaderElection

AuthFastLeaderElection 算法是 FastLeaderElection 算法扩展，它在消息中加入了认证。

> 该算法已在 Zookeeper 3.4 中废弃了。

## 30、ZookeeperLeader 选举的前提条件是？

##### 1、Zookeeper 服务器处于 LOOKING 竞选状态

此时说明 Zookeeper 服务器集群处于群龙无首状态，另外，观察者状态不能参与竞选投票。

##### 2、Zookeeper 集群规模至少要 3 台机器或以上

集群规则为：2N+1 台，N>0，即最少需要 3 台，因为 ZK 集群的机制是只要超过半数的节点正常，集群就能正常提供服务。只有在 ZK 节点挂得太多，只剩一半或不到一半节点能工作时，集群才会失效。

##### 如以下分析所示：

> 3 个节点的 Cluster 可以挂掉 1 个节点(Leader 可以得到 2 票〉1.5)
>
> 2 个节点的 Cluster 就不能挂掉任何 1 个节点了(Leader 可以得到 1 票<= 1)

##### 3、Zookeeper 集群要 2 台及以上机器可以互相通信

只要达到 2 台服务器通信了才能进行选举，只有一台服务器启动时无法进行选举，因为服务器之间通信了才可以互相同步投票结果。

## 31、Zookeeper 启动时选举流程是怎样的？

##### 选举大致过程：

##### 1、初始投票

服务器启动后，每个 Server 都会给自己投上一票，每次投票会包含所投票服务器的 myid 和 zxid，这里使用 Server（myid,zxid）的方式表示，此时的投票结果为：zk1(1,0)，zk2(2,0)，zk3(3,0)

##### 2、同步投票结果

集群中的服务器在投票后，会将各自的投票结果同步给集群中其他服务器。

##### 3、检查投票有效性

各服务器在收到投票后会检查投票的有效性，如：是否本轮投票，是否来自 LOOKING 状态的服务器的投票等。

##### 4、处理投票

服务器之间会进行投票比对，规则如下：·优先检查 zxid，较大的服务器优先作为 Leader·如果 zxid 相同，则 myid 较大的服务器作为 Leader 如：zk1 和 zk2 进行比对，此时 zk2 胜出，zk1 更新自己的投票为：zk1(2,0)

##### 5、统计投票结果

每轮投票比对之后都会统计投票结果，确认是否有超过半数的机器都得到相同的投票结果，如果是，则选出 Leader，否则继续投票。本轮选举中，zk1 和 zk2 都得到了相同的投票结果（2,0），2 指 zk2，并且超过了半数的机器（2>3／ 2）所以此时 zk2 就成为了本轮选举的 Leader。所以，即使 zk3 启动了，因为集群已经有了 Leader，所以选举也结束了，zk3 不再参与选举，后面进来的都是小弟。

##### 6、更改服务器状态

一旦选出 Leader，每个服务器就会各自更新自己的状态：

> zk1 >>> FOLLOWING
>
> zk2 >>> LEADING
>
> zk3 >>> FOLLOWING

## 32、Zookeeper 重新选举流程是怎样的？

#### 选举大致过程：

##### 1、状态变更

既然过去的老大 Leader 不可用了，那所有的 Follower 服务器就需要从 FOLLOWING 状态变更为：LOOKING，开始新的一轮 Leader 选举。

##### 2、开始投票

投票逻辑和启动初始时一致。

zk1，zk3 第一轮投票默认还是会先投给自己，zk2 挂了不能进行投票。第一轮投票结果为：zk1（1,66）、zk3（3,28），zk1 和 zk3 各得一票，这里假设 zk1 事务 ID 比 zk3 更大一点。

##### 3、同步投票结果

同步投票逻辑和启动初始时一致。

##### 4、检查投票有效性

检查投票逻辑和启动初始时一致。

##### 5、处理投票

处理投票逻辑和启动初始时一致。此时 zk1 和 zk3 进行比对，根据规则，由于 zk1 的事务 ID 更大一点，所以 zk1 胜出，zk3 也更新自己的投票为：zk3 (1, 28)

##### 6、统计投票结果

统计投票逻辑和启动初始时一致。本轮选举中，zk1 和 zk3 都得到了相同的投票结果 zk1，并且超过了半数的机器（2>3／ 2），所以此时 zk1 就成为了本轮选举的 Leader。

##### 7、更改服务器状态

更改状态逻辑和启动初始时一致。

## 33、Zookeeper 支持哪些 Java 客户端？

主要使用的有两个：

1）ZooKeeper 自带的：**zkclient**

2）Apache 开源的：**Apache Curator**

## 34、Zookeeper 有几种部署模式？

##### 1、单机模式

在一台机器上启动一个 ZooKeeper 实例。

##### 2、伪集群模式

在一台机器上启动不同端口的 ZooKeeper，和单机模式相同，此模式一般用在测试环境。

##### 3、集群模式

在不同机器上启动多个 ZooKeeper 实例。

## 35、Zookeeper 集群最少要几台机器，为什么？

##### 集群规则为：2N+1 台，N>0，即最少需要 3 台。

因为 ZK 集群的机制是只要超过半数的节点正常，集群就能正常提供服务。只有在 ZK 节点挂得太多，只剩一半或不到一半节点能工作，集群才失效。

##### 如以下分析所示：

3 个节点的 Cluster 可以挂掉 1 个节点 (Leader 可以得到 2 票> 1.5)

2 个节点的 Cluster 就不能挂掉任何 1 个节点了 (Leader 可以得到 1 票<= 1)

## 36、Zookeeper 集群支持动态添加机器吗？

ZooKeeper 3.5+版本开始支持动态扩容。

## 37、Zookeeper 是如何实现分布式事务的？

##### ZooKeeper 实现分布式事务，类似于两阶段提交：

1）客户端给 ZooKeeper 节点发送写请求

2）ZooKeeper 节点将写请求转发给 Leader 节点

3）Leader 广播给集群要求投票，等待确认

4）Leader 收到确认，统计投票，票数过半则提交事务

5）ZooKeeper 节点在事务提交成功后通知客户端

## 38、Zookeeper 和 Chubby 的区别？

Chubby 是 Google 完全实现 Paxos 算法，不开源。

Zookeeper 是 Chubby 的开源实现，使用 Zab 协议，是 Paxos 算法的变种。

## 39、Zookeeper 分布式一致性用的什么协议？

Zookeeper 在解决分布式一致性方面并没有使用 **Paxos** 协议，而是采用了 **ZAB** 协议。

## 40、什么是 ZAB 协议？

**ZAB** 协议的全称为：**Zookeeper Atomic Broadcast**，即：Zookeeper 原子广播协议。

ZAB 是为分布式协调服务 Zookeeper 专门设计的一种支持 **崩溃恢复**和**原子广播** 的协议。

## 41、ZAB 和 Paxos 算法的联系与区别？

##### 相同点：

- 都有一个类似于 Leader 进程的角色，负责协调多个 Follower 进程的运行
- Leader 进程都会等待超过半数的 Follower 正确反馈后，才会进行提交
- 每个 Proposal 都包含一个 epoch 值来代表当前的 Leader 周期

##### 不同点：

ZAB 用来构建高可用的分布式数据主备系统（Zookeeper）

Paxos 是用来构建分布式一致性状态机系统。
