## 1、Sentinel 是什么？

**Sentinel**------面向分布式、多语言异构化服务架构的流量治理组件，由阿里巴巴于 2012 年开发，2018 年开源，是 **Spring Cloud Alibaba** 体系中的重要组件之一。

**Sentinel**主要以流量为切入点，从**流量控制、流量路由、熔断降级、系统自适应保护**等多个维度来帮助用户保障微服务的稳定性。

官方网站：https://sentinelguard.io/

开源地址: https://github.com/alibaba/Sentinel

##### Sentinel 的生态图：

![](/images/Sentinel/1.jpg)

## 2、Sentinel 有什么优势？

##### 1、丰富的应用场景

阿里巴巴 10 年双十一积累的丰富流量场景，包括秒杀、双十一零点持续洪峰、热点商品探测、预热、消息队列削峰填谷等多样化的场景。

##### 2、易于使用，快速接入

简单易用，开源生态广泛，针对 Dubbo、Spring Cloud、gRPC、Zuul、Reactor、Quarkus 等框架只需要引 l 入适配模块即可快速接入。

##### 3、多样化的流量控制

资源粒度、调用关系、指标类型、控制效果等多维度的流量控制。

##### 4、可视化的监控和规则管理

简单易用的 Sentinel 控制台。

## 3、Sentinel 的主要功能有哪些？

Sentinel 的主要功能包括：

##### 1、高并发流量控制

在高访问量的场景下，使用 Sentinel 进行流量限制，防止系统过载，这包括对 API 接口的限流，保证系统在用户访问激增时仍能稳定运行。

##### 2、服务熔断降级

当下游服务不稳定或响应时间过长时，通过熔断机制暂时阻断服务调用，防止故障蔓延，保护系统免受进一步影响。

##### 3、系统负载保护

Sentinel 可以根据系统的负载情况（如 CPU 使用率、总体吞吐量）动态调整流量控制策略，确保系统不被过载。

## 4、 Sentinel、Hystrix 和 resilience4j 的区别？

如下表所示：

| 对比项            | Sentinel                                               | Hystrix                | resilience4j                     |
| ----------------- | ------------------------------------------------------ | ---------------------- | -------------------------------- |
| 隔离策略          | 信号量隔离 (并发控制)                                  | 线程池隔离/信号量隔离  | 信号量隔离                       |
| 熔断降级策略      | 基于慢调用比例、异常比例、异常数                       | 基于异常比例           | 基于异常比例、响应时间           |
| 实时统计实现      | 滑动窗口（LeapArray）                                  | 滑动窗口 (基于 RxJava) | Ring Bit Buffer                  |
| 动态规则配置      | 支持多种数据源                                         | 支持多种数据源         | 有限支持                         |
| 扩展性            | 多个扩展点                                             | 插件的形式             | 接口的形式                       |
| 基于注解的支持    | 支持                                                   | 支持                   | 支持                             |
| 限流              | 基于 QPS，支持基于调用关系的限流                       | 有限的支持             | Rate Limiter                     |
| 流量整形          | 支持预热模式与匀速排队控制效果                         | 不支持                 | 简单的 Rate Limiter 模式         |
| 系统自适应保护    | 支持                                                   | 不支持                 | 不支持                           |
| 多语言支持        | Java/Go/C++                                            | Java                   | Java                             |
| Service Mesh 支持 | 支持 Envoy/lstio                                       | 不支持                 | 不支持                           |
| 控制台            | 提供开箱即用的控制台，可配置规则、实时监控、机器发现等 | 简单的监控查看         | 不提供控制台，可对接其它监控系统 |

## 5、Sentinel 有哪几种使用方式？

Sentinel 主要有两种使用方式：

##### 1、核心库

不依赖任何框架/库，能够运行于 Java 8 及以上的版本的运行时环境，同时对 Dubbo/Spring Cloud 等框架也有较好的支持。

##### 2、控制台

控制台主要负责管理推送规则、监控、管理机器信息等。

---

核心库不依赖控制台，但是可以结合控制台取得最好的效果。

## 6、Sentinel 可否用于生产环境？

Sentinel 目前已可用于生产环境，除了阿里巴巴以外，也有很多企业在生产环境中广泛使用 Sentinel。

Sentinel 控制台项目虽然提供 Sentinel 功能全集示例，但不能作为开箱即用的生产环境控制台，若希望在生产环境使用，请根据官方文档自行进行定制和改造。

### 7、Sentinel 支持哪些开源框架适配？

Sentinel 开源框架适配：

- 云原生微服务体系

  - Spring Boot/Spring Cloud
  - Quarkus

- Web 适配

  - Web Servlet
  - Spring Web
  - Spring WebFlux
  - JAX-RS (Java EE)

- RPC 适配

  - Apache Dubbo
  - gRPC
  - Feign
  - SOFARPC

- HTTP client 适配

  - Apache HttpClient
  - OkHttp

- Reactive 适配

  - Reactor

- APl Gateway 适配

  - Spring Cloud Gateway
  - Netflix Zuul 1.x
  - Netlix Zuul 2.x

- Apache RocketMQ

### 8、Sentinel 的性能怎么样？

引入 Sentinel 带来的性能损耗非常小。

Sentinel 只有在业务单机量级超过 25W QPS 的时候才会有一些显著的影响，性能损耗在 10% 左右，这种情况业务逻辑本身的耗时非常小，而 Sentinel 一系列的统计、检查操作会消耗一定的时间，比如常见的场景有缓存读取操作。

![](/images/Sentinel/8_1.jpg)

当单机 QPS 不太大的时候损耗几乎可以忽略不计，比如当单机 QPS 在 5W 以下的时候，Sentinel 的性能损耗就比较小了，对大多数场景来说都适用。

![](/images/Sentinel/8_2.jpg)

### 9、Sentinel 的工作机制是怎样的？

Sentinel 的主要工作机制如下：

1、在 Sentinel 里面，所有的资源都对应一个资源名称以及一个 Entry，Entry 可以通过对主流框架的适配自动创建，也可以通过注解的方式或调用 API 显式创建，用来定义需要保护的资源，并提供相关机制对资源进行实时统计和调用链路分析。

2、根据预设的规则，结合对资源的实时统计信息，对流量进行控制。同时，Sentinel 提供开放的接口，可以很方便定义及改变规则。

3、Sentinel 提供实时的监控系统，方便快速了解目前系统的状态。

## 10、Sentinel 的核心架构是怎样的？

Sentinel 的核心架构图如下：

![](/images/Sentinel/10_1.jpg)

每一个 Sentinel 资源（**Entry**）创建的时候，同时也会创建一系列功能插槽（**Slot Chain**），不同的插槽对应不同的职责。

Sentinel 将多个不同的插槽（**Slot**）按照顺序串在一起（**责任链模式**），从而可以将不同的功能（**限流、降级、系统保护**）组合在一起。

![](/images/Sentinel/10_2.jpg)

**Slot Chain** 可以分为部分：

- 统计数据构建部分（statistic）
- 规则判断部分（rule checking）

Sentinel 目前的设计是一个**插槽链对应一个资源**，因为某些插件是对应某个资源的（比如 NodeSelectorSlot）。

## 11、Sentinel 有哪些插槽？都有什么用？

##### 以下是 Sentinel 各个插槽的职责：

| 插槽名称           | 功能描述                                                                                          |
| ------------------ | ------------------------------------------------------------------------------------------------- |
| NodeSelectorSlot   | 负责收集资源的路径，将资源调用路径以树状结构存储，用于根据调用路径进行限流降级。                  |
| ClusterBuilderSlot | 用于存储资源的统计信息及调用者信息，如资源的 RT,QPS,thread count 等，作为多维度限流、降级的依据。 |
| StatisticSlot      | 用于记录和统计不同维度的 runtime 指标监控信息。                                                   |
| FlowSlot           | 根据预设的限流规则及前面 slot 统计的状态，进行流量控制。                                          |
| AuthoritySlot      | 根据配置的黑白名单和调用来源信息，进行黑白名单控制。                                              |
| DegradeSlot        | 通过统计信息和预设规则，执行熔断降级操作。                                                        |
| SystemSlot         | 通过系统状态（如 load1）来控制总的入口流量。                                                      |

## 12、Sentinel 中的插槽可以扩展吗？是怎么实现的？

Sentinel 中的插槽是可以扩展的，Sentinel 提供了一个 Processorslot SPl 接口，使得 Slot Chain 具备了扩展插槽的能力。

如下图所示：

![](/images/Sentinel/12.jpg)

我们可以自行加入自定义的插槽并编排插槽的顺序，从而可以给 Sentinel 添加更多自定义的功能。

## 13、Sentinel 提供了哪些 SPI 扩展点？

Sentinel 提供了多样化的 SPl 接口，支持自行添加扩展接口实现，从而可以方便地根据业务需求给 Sentinel 添加自定义的逻辑。

##### 目前 Sentinel 提供如下的扩展点：

| 扩展类型             | 描述                                                            |
| -------------------- | --------------------------------------------------------------- |
| 初始化过程扩展       | 用于添加自定义的一些初始化逻辑，如动态规则源注册等。            |
| Slot/Slot Chain 扩展 | 用于给 Sentinel 功能链添加自定义的功能并自由编排。              |
| 指标统计扩展         | 用于扩展 StatisticSlot 指标统计相关的逻辑。                     |
| Transport 扩展       | 用于对心跳发送、监控 API Server 进行扩展。                      |
| 集群流控扩展         | 用于方便定制 token client/server 的自定义实现。                 |
| 日志扩展             | 用于自定义 record log Logger，可用于对接 slf4j 等标准日志实现。 |

具体 SPI 接口如下图所示：

![](/images/Sentinel/13.jpg)

## 14、Sentinel 中的 Context 是什么？

Context 是指 Sentinel 中的调用链路上下文，Context 名称即为调用链路入口名称，它贯穿了一次调用链路中的所有`Entry`。

Context 维持着以下几个关键信息：

- 入口节点 （entranceNode）
- 当前节点（curNode）
- 调用来源（origin）

每个请求进入 Sentinel 时，都会创建一个 Context 对象，该对象包含了请求的上下文信息，这个 Context 会被用来判断请求是否通过流控规则。

## 15、Sentinel 中的 Context 是怎么在多线程环境中传递的？

Sentinel 中的 Context 是通过 Java 中的线程本地变量（**ThreadLocal**）进行传递的，确保每个线程都有自己的上下文信息，但是只有在入口 enter 的时候生效。

由于 Context 是通过 ThreadLocal 传递的，因此对于异步调用链路，线程切换的时候就会丢失当前的 Context，所以，在这种情况下，需要手动通过以下方法来切换 Context:

```java
Contextutil.runoncontext(context, f)
```

## 16、Sentinel 中的资源是指什么？

Sentinel 中的资源可以是 Java 应用程序中的任何内容，比如以下内容：

- 可以是一个 API 接口
- 可以是一个方法
- 可以是一段代码

即只要是通过 Sentinel API 定义的代码，就是资源，它能够被 Sentinel 保护起来。

> 一般情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。

## 17、Sentinel 怎么定义一个资源？

Sentinel 中最常用的资源是我们代码中的 Java 方法、代码块。

##### 定义方法资源

---

通过 Sentinel 提供的注解定义方法资源。

示例代码：

```java
@sentinelResource("getuserInfo")
public void getuserInfo() {
    // 资源中的逻辑
    System.out.println("NB");
}
```

这样，`getUserInfo()`方法就成了 Sentinel 中的一个资源。

> ##### 需要注意的是：
>
> 注解支持模块需要配合 Spring AOP 或者 AspectJ 一起使用。

##### 定义代码块资源

---

定义代码块资源，可以使用 Sentinel API 将代码块包围起来即可。

示例代码：

```java
public static void main(string[] args) {
    // 配置规则.
    initFlowRules();

    while (true) {
        try (Entry entry = sphu.entry("getuserInfo")) {
            // 被保护的逻辑
            System.out.println("NB");
        } catch (BlockException ex) {
            // 处理被流控的逻辑
            System.out.println("被限流了!");
        }
    }
}
```

这样，被 Sentinel APl 包围的代码就是 Sentinel 中的一个资源。

## 18、Sentinel 中的 Entry 是指什么？

Entry 是 Sentinel 中的**流量控制实体**，它代表了对某个资源的**一次访问请求或调用**。

每当应用程序请求访问某个资源时，Sentinel 会创建一个 Entry 来代表这次访问，然后根据流控规则来决定是否允许这次访问。

Entry 记录了每次请求的上下文信息，如资源名称、流控规则、通过与否等。

## 19、Sentinel 资源和 Entry 的关系？

资源表示被保护的对象，而 Entry 表示对资源的具体访问请求：

- **每个资源都可以拥有多个与之关联的 Entry**，这些 Entry 对应着不同的请求或调用。一个资源可以同时被多个请求访问，每个请求都会生成一个对应的 Entry。
- **Entry 在进入资源时会经过流控规则的检查**，如果通过规则检查，请求将继续执行，否则将会触发流控的处理逻辑，如拒绝、降级、排队等。

Sentinel 是通过资源和 Entry 来实现流量控制和保护的。

## 20、Sentinel 中的规则是指什么？

Sentinel 中的规则即，围绕资源的实时状态设定一些规则，规则可以是以下几种：

- 流量控制规则
- 熔断降级规则
- 系统保护规则

Sentinel 中的所有规则，都可以动态实时调整。

## 21、Sentinel 支持哪几种规则？

Sentinel 支持以下 5 种规则：

- 流量控制规则
- 熔断降级规则
- 系统保护规则
- 来源访问控制规则
- 热点参数规则

## 22、Sentinel 怎么定义一个规则？

比如指定允许该资源通过的请求次数：

```java
private static void initFlowRules() {
    List<FlowRule> rules = new ArrayList<>();
    FlowRule rule = new FlowRule();
    rule.setResource("getuserInfo");
    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    //设置QPS为20
    rule.setcount(20);
    rules.add(rule);
    FlowRuleManager.loadRules(rules);
}
```

上面的代码定义了资源`getUserInfo`每秒最多只能通过 20 个请求。

在 Sentinel 控制台页面也可以定义规则：

![](/images/Sentinel/22.jpg)

这里添加的规则需要持久化，不然重启就会没有了。

## 23、Sentinel 中的规则默认存储在哪里？

Sentinel 中的规则默认是**存储在内存里面**的，没有进行持久化，因此应用重启后规则就消失了，需要自行根据官方文档实现持久化存储规则功能。

## 24、Sentinel 如何实现持久化规则？

Sentinel 中的规则配置，默认都是存在内存中的，即如果应用重启，这个规则就会失效。

Sentinel 提供了了一个`DataSource`接口，通过实现它来自定义规则的持久化。

##### 常见的整合方案有：

- 整合动态配置系统，如 ZooKeeper、Nacos、Apollo 等，动态地实时刷新配置规则；
- 结合 RDBMS、NoSQL、VCS 等来实现该规则；

## 25、Sentinel 有哪几种修改规则的方式？

Sentinel 的理念是开发者只需要关注资源的定义，当资源定义成功后可以动态增加各种流控降级规则。

Sentinel 提供两种方式修改规则：

- 通过 API 直接修改
- 通过`DataSource`适配不同数据源修改

通过 API 修改比较直观，一般仅用于测试和演示，生产环境一般建议通过数据源的方式来动态管理规则。

## 26、Sentinel 中的规则如何动态更新？

Sentinel 规则动态更新的常见方法：

##### 1、使用 Sentinel 控制台

Sentinel 提供了一个控制台应用，通过它可以方便地管理和更新规则，控制台会将规则的更改实时推送到连接的客户端。

##### 2、集成配置中心

将 Sentinel 规则存储在外部配置中心，如 Nacos、Apollo、Zookeeper 等。当配置中心中的规则发生变更时，可以通过监听机制实时更新客户端的规则。

##### 3、API 动态更新

Sentinel 提供了 API 接口，允许通过编程方式动态添加、修改或删除流控规则。可以根据业务需要，通过调用这些 API 接口来实现规则的动态变更。

## 27、Sentinel 动态规则数据源分为哪几种？各自的使用场景？

Sentinel 动态规则数据源分为：

##### 可写入的数据源：

一般对应 pull 模式的数据源（如本地文件、RDBMS），从控制台推送规则时可先经 Sentinel 客户端更新到内存中，然后经注册的 WritableDatasource 写入到本地。

##### 只读的数据源：

一般对应 push 模式的数据源（如配置中心等），对于配置中心，写入的操作不应由数据源进行，数据源仅负责获取配置中心推送的配置并更新到本地。

## 28、Sentinel 规则推送有哪几种模式？

规则的推送有下面三种模式：

| 推送模式  | 说明                                                                                                                                                                                                             | 优点                         | 缺点                                                               |
| --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- | ------------------------------------------------------------------ |
| 原始模式  | 扩展写数据源（WritableDataSource），API 将规则推送至客户端并直接更新到内存中。                                                                                                                                   | 简单，无任何依赖             | 不保证一致性；规则保存在内存中，重启即消失。严重不建议用于生产环境 |
| Pull 模式 | 扩展写数据源（WritableDataSource），客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是 RDBMS、文件等。                                                                                             | 简单，无任何依赖；规则持久化 | 不保证一致性；实时性不保证，拉取过于频繁也可能会有性能问题。       |
| Push 模式 | 扩展读数据源（ReadableDataSource）规则中心统一推送，客户端通过注册监听器的方式时刻监听变化，比如使用 Nacos、Zookeeper 等配置中心。这种方式有更好的实时性和一致性保证。**生产环境下一般采用 push 模式的数据源。** | 规则持久化；一致性；快速     | 引入第三方依赖                                                     |

## 29、Sentinel 中的流量控制是怎样的？

任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的，我们需要根据系统的处理能力对流量进行控制。

Sentinel 作为一个调配器，**它会根据需要把随机的请求调整成合适的形状**，如下图所示：

![](/images/Sentinel/29.jpg)

流量控制有以下几个角度：

- 资源的调用关系，例如资源的调用链路，资源和资源之间的关系；
- 运行指标，例如 QPS、线程池、系统负载等；
- 控制的效果，例如直接限流、冷启动、排队等。

Sentinel 的设计理念是让你可以自由选择控制的角度，并进行灵活组合，从而达到想要的效果。

## 30、Sentinel 支持哪几种流量控制统计类型？

如图所示：

![](/images/Sentinel/30.jpg)

Sentinel 流量控制主要有两种统计类型：

- QPS
- 并发线程数

## 31、Sentinel 流量控制的手段有哪些？

流量控制的手段包括下面 3 种：

##### 1、直接拒绝 (默认)

该方式是默认的流量控制方式，当 QPS 超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出`FlowException`异常。

这种方式适用于对系统处理能力确切已知的情况下，比如通过压测确定了系统的准确水位时。

##### 2、冷启动

该方式主要用于系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。

通过“**冷启动**”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮的情况。

##### 3、匀速器

这种方式严格控制了请求通过的间隔时间，即让请求以均匀的速度通过，对应的是漏桶算法。

## 32、Sentinel 触发限流后如何处理？

具体如果处理还要看具体的业务和场景，一般有以下两种处理方案。

##### 1、拦截限流异常

全局拦截限流后的异常，然后返回友好的提示，或者做其他操作。

##### 2、自定义限流

如果资源使用了`@SentinelResource`注解，可以使用 @SentinelResource(**blockHandler**="blockError")指定被限流后的处理方法。

## 33、Sentinel 支持集群限流吗？

1.4.0 版本开始已经支持。

## 34、Sentinel 为什么要使用集群流控？

集群流控的作用有以下几点：

##### 1、保证通信稳定性

假设我们希望给某个用户限制调用某个 API 的总 QPS 为 50，但机器数可能很多，比如有 100 台，但不一定全部可用，可能出现通信异常的情况。

这种情况，使用集群流控，可以找一个 Server 来专门来统计总的调用量，其它的实例都与这台 Server 通信来判断是否可以调用，保证了通信稳定性。

##### 2、解决流量不均匀的问题

假设集群中有 10 台机器，我们给每台机器设置单机限流阈值为 10QPS，流量到达每台机器可能会不均匀，会导致总量没有到的情况下某些机器就开始限流。

这种情况，靠单机维度去限制无法精确地限制总体流量，使用集群流控可以精确地控制整个集群的调用总量，结合单机限流兜底，可以更好地发挥流量控制的效果。

通过集群流控，Sentinel 能够确保在分布式环境下，整个系统的流量得到有效管理，从而避免因单个服务实例的流量控制不当导致的系统不稳定问题。

## 35、Sentinel 集群流控有哪几种身份？

集群流控共有两种身份：

![](/images/Sentinel/35.jpg)

##### 1、集群流控客户端(Token Client)

用于向所属 Token Server 通信请求 token，集群限流服务端会返回给客户端结果，决定是否限流。

##### 2、集群流控服务端(Token Server)

用于处理来自 Token Client 的请求，根据配置的集群规则判断是否应该发放 token，即是否允许通过。

## 36、Sentinel 集群流控的工作流程？

Sentinel 集群流控的工作流程：

##### 1、集群模式设置

在 Sentinel 中，可以将流控模式设置为集群模式，流控规则将基于整个集群的流量而不是单个实例的流量。

##### 2、集群节点通信

在集群模式下，各个 Sentinel 实例（或者说是集群中的应用节点）需要进行通信，这是通过集群中的 Token Server（令牌服务器）来实现的，Token Server 负责维护和分发流控令牌。

##### 3、流量统计上报

每个 Sentinel 实例会定期将自己监控到的流量数据上报给 Token Server，这些数据包括请求次数、通过的请求、阻塞的请求等。

##### 4、动态流控决策

Token Server 根据汇总的全局流量数据和预设的流控规则，动态计算当前集群可允许的流量阈值，并据此分发流控令牌。

##### 5、令牌获取与响应

当一个应用实例需要处理请求时，它会向 Token Server 请求令牌。如果令牌获取成功（即当前流量未超出集群阈值），请求得以执行；如果令牌获取失败（即流量超限），请求会被限流。

##### 6、自适应调整

随着集群流量的变化，Token Server 会不断调整令牌发放策略，确保整个集群的流量控制既公平又高效。

## 37、Sentinel 集群限流服务端有哪几种启动方式？

Sentinel 集群限流服务端有两种启动方式：

##### 1、独立模式(Alone)

即作为独立的 token server 进程启动，独立部署，隔离性好，但是需要额外的部署操作。

![](/images/Sentinel/37_1.jpg)

独立模式适合作为 Global Rate Limiter 给集群提供流控服务。

##### 2、嵌入模式 (Embedded)

即作为内置的 token server 与服务在同一进程中启动，集群中各个实例都是对等的，token server 和 client 可以随时进行转变，因此无需单独部署，灵活性比较好,但是隔离性不佳，需要限制 token server 的总 QPS，防止影响应用本身。

![](/images/Sentinel/37_2.jpg)

嵌入模式适合某个应用集群内部的流控。

## 38、Sentinel 支持对网关限流吗？都支持哪些网关？

Sentinel 支持对 **Spring Cloud Gateway、Zuul** 等主流的 API Gateway 进行限流。

![](/images/Sentinel/38.jpg)

拿 **Spring Cloud Gateway** 举例，从 Sentinel 1.6.0 版本开始，Sentinel 提供了 Spring Cloud Gateway 的适配模块，可以提供两种资源维度的限流：

- **route 维度**：即在 Spring 配置文件中配置的路由条目，资源名为对应的 routeld
- **自定义 API 维度**：用户可以利用 Sentinel 提供的 API 来自定义一些 API 分组

注意，网关目前默认不支持 **URL** 粒度的限流。

## 39、Sentinel 如何对热点参数限流？

热点即经常访问的数据，很多时候，我们希望统计某个热点数据中访问频次最高的 TopK 数据，并对其访问进行限制，比如：

- 以商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制
- 以用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制

![](/images/Sentinel/39_1.jpg)

热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效，热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值进行限流。

如下图所示：

![](/images/Sentinel/39_2.jpg)

Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。

## 40、Sentinel 支持根据前缀匹配限流吗？

在 Web 应用中，URL 可能包含各种动态参数，比如`/product/1` 和`/product/2`，这些 URL 在逻辑上是相同的，但因为路径参数的不同，在流量控制时会被视为不同的资源。

如果匹配前缀限流，可以借助`urlcleaner` 处理对应的 URL，如提取前缀的操作，这样对应的资源都会归到处理后的资源，如`/product/1` 和`/product/2` 都归到/product/\*资源里面。

---

在 1.8.7 版本中，Sentinel 引 I 入了资源名称支持正则匹配的新特性来支持更加灵活的资源匹配，提高配置效率。

配置示例如下：

```java
// 匹配以/product/为前缀的资源名
private static final String KEY = "/product/.*";

private static void initFlowQpsRule() {
    List<FlowRule> rules = new ArrayList<FlowRule>();
    FlowRule rulel = new FlowRule();rulel.setResource(KEY);

    // set Limit qps to 20
    rulel.setcount(20);
    rule1.setGrade(Ruleconstant.FLON_GRADE_QPS);
    rule1.setRegex(true);
    rulel.setLimitApp("default");
    rules.add(rule1);

    FlowRuleManager.loadRules(rules);
}
```

## 41、Sentinel 如何做来源访问控制？

比如，有些时候，我们需要根据调用方来限制资源是否通过，这时候可以使用 Sentinel 的**黑白名单控制**的功能：

![](/images/Sentinel/41.jpg)

黑白名单根据资源的请求来源（`origin`）限制资源是否通过：

- 若配置白名单，则只有请求来源位于白名单内时才可通过；
- 若配置黑名单，则请求来源位于黑名单时不通过，其余的请求通过。

## 42、Sentinel 是如何实现高性能的流量统计的？

Sentinel 实现高性能流量统计主要依靠以下几个关键技术：

##### 1、滑动窗口算法

Sentinel 使用了滑动窗口算法来统计实时的秒级指标数据，这种算法可以在保持数据精度的同时，减少内存的占用和计算的复杂度，可以很好地支撑写多于读的高并发场景。

![](/images/Sentinel/42.jpg)

##### 2、无锁设计

为了提高性能，Sentinel 在实现上采用了无锁设计，通过使用原子类和并发工具来减少线程间的阻塞和竞争，提高了统计数据的处理效率。

##### 3、懒加载和预热

Sentinel 在资源首次被访问时才会创建对应的统计和控制结构，这种懒加载方式减少了系统的初始负载。同时，Sentinel 还支持预热功能，帮助系统平滑过渡到稳定状态。

##### 4、时间窗口切分

Sentinel 将统计的时间窗口切分成多个小的时间片段，每个时间片段独立统计，最后合并结果。这种方式既保证了统计的实时性，又减少了数据处理的复杂度。

##### 5、异步处理

部分统计和日志记录操作是异步进行的，这样可以减少对主业务流程的影响，提高系统的整体性能。通过这些技术手段，Sentinel 能够在保证统计数据准确性的同时，最大限度地减少对系统性能的影响，实现高效的流量统计和控制。

## 43、Sentinel 用到了哪些限流算法？

##### 1、漏桶算法

漏桶算法将请求放入一个"桶"中，系统以固定速率处理桶中的请求，当桶满时，新的请求会被拒绝，这种算法能够保证系统处理请求的稳定性。

##### 2、令牌桶算法

令牌桶算法通过一个填充令牌的桶来控制流量，每个请求需要消耗一定数量的令牌，如果桶中令牌不足，请求会被限流。

令牌桶算法比漏桶算法更灵活，可以应对突发流量。

##### 3、预热限流

预热限流适用于系统刚启动时资源还不足的情况，它会设置一个预热期，在这个期间内限流阈值会逐渐从一个较低的值增长到设定的阈值，帮助系统平滑过渡到高负载状态。

## 44、Sentinel 的限流策略在高流量时如何调整？

在面对高流量场景时，调整 Sentinel 的限流策略是至关重要的，以确保系统稳定运行并有效处理大量请求。

以下是一些在高流量时调整 Sentinel 限流策略的建议：

##### 1、动态调整流量阈值

根据实时流量和系统负载动态调整限流阈值，可以使用 Sentinel 控制台或集成配置中心（如 Nacos、Apollo）来实时更新限流规则。

##### 2、预热限流策略

对于预期流量会逐渐增加的场景，可以使用预热限流策略，这种策略允许系统逐步适应流量增加，避免因突发流量造成的冲击。

##### 3、排队等待策略

在高流量场景下，可以使用排队等待策略，这种策略允许请求以一定速率进入系统，超出速率的请求则需要等待，从而平滑处理流量高峰。

##### 4、集群流量控制

如果是分布式系统，考虑使用 Sentinel 集群流量控制，确保整个集群的流量得到有效平衡。

##### 5、降级和熔断策略

结合降级和熔断策略，当系统即将超载时，自动降级部分服务或暂时断开部分服务，保护系统核心功能。

##### 6、多维度限流

根据不同的维度设置限流规则，如来源、API 等，这样可以更精细地控制流量。

##### 7、负载均衡和扩容

结合负载均衡策略，合理分配流量到多个处理节点，在必要时进行服务扩容，增加处理能力。

## 45、Sentinel 如何处理异步调用的流量控制？

Sentinel 处理异步调用的流量控制是一个挑战，因为异步调用的执行时间和完成时间不确定，这可能会导致流量控制的难度增加。

不过，Sentinel 提供了一些机制来处理异步调用的流量控制：

##### 1、异步调用的资源包装

Sentinel 支持异步调用链路的统计，它允许将异步操作包装为一个资源，需要通过`Sphu.asyncEntry(xxx)`方法定义资源，并通常需要在异步的回调函数中调用 exit 方法，这样就可以对这个资源应用流量控制规则。

##### 2、入口资源与出口资源分离

在异步调用中，可以将发起调用的部分（入口资源）和异步执行的部分（出口资源）分开处理，为入口资源和出口资源分别配置流量控制规则，这样就可以更细粒度地控制异步流量。

##### 3、上下文传递

在异步调用中，确保 Sentinel 的上下文（比如当前线程的资源调用链）能够在异步执行时传递和保持，这样可以确保异步执行部分仍然在正确的 Sentinel 上下文中执行，保持流量控制的一致性。

## 46、什么是熔断降级？

如下图所示：

![](/images/Sentinel/46.jpg)

一个请求可能涉及多个服务，服务之间的调用链又非常复杂，如果调用链路中的某个服务出现了不稳定，最终会导致请求发生堆积。

Sentinel 和 Hystrix 的原则是一致的：

> 当调用链路中某个服务出现不稳定，比如说调用服务超时，当异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终产生雪崩的效果。

## 47、Sentinel 支持哪几种熔断策略？

Sentinel 提供以下几种熔断策略：

![](/images/Sentinel/47.jpg)

##### 1、慢调用比例(SLOW_REQUEST_RATIO)

选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。

当单位统计时长（`statIntervalMs`）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。

##### 2、异常比例(ERROR_RATIO)

当单位统计时长（`statIntervalMs`）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。

经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是`[0.0，1.0]`，代表 0%- 100%。

##### 3、异常数(ERROR_COUNT)

当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。

## 48、Sentinel 是怎么设计熔断降级的？

关于熔断降级，Sentinel 和 Hystrix 采取了完全不一样的设计方法。

Sentinel 对这个问题采取了两种手段：

##### 1、通过并发线程数进行限制

和资源池隔离的方法不同，**Sentinel 通过限制资源并发线程的数量，来减少不稳定资源对其它资源的影响**，这样不但没有线程切换的损耗，也不需要您预先分配线程池的大小。

当某个资源出现不稳定的情况下，例如响应时间变长，对资源的直接影响就是会造成线程数的逐步堆积。

当线程数在特定资源上堆积到一定的数量之后，对该资源的新请求就会被拒绝，堆积的线程完成任务后才开始继续接收请求。

##### 2、通过响应时间对资源进行降级

除了对并发线程数进行控制以外，Sentinel 还可以通过响应时间来快速降级不稳定的资源。

当依赖的资源出现响应时间过长后，所有对该资源的访问都会被直接拒绝，直到过了指定的时间窗口之后才重新恢复。

## 49、Sentinel 的熔断机制是如何工作的？

Sentinel 的熔断机制主要是基于熔断降级规则来实现的，其工作原理可以概括为以下几个步骤：

##### 1、资源监控

Sentinel 对指定的资源（如某个服务或接口）进行监控，收集相关的调用数据，比如响应时间、异常比例等。

##### 2、熔断判断

根据定义的熔断规则，Sentinel 会定期检查资源的运行状况。

##### 3、熔断开启

一旦某个资源的运行状况触发熔断规则，Sentinel 会立即对该资源进行熔断，此时对该资源的所有后续调用都会被快速失败，不再执行实际的业务逻辑。

##### 4、探测恢复状态

熔断后，资源会进入一个“探测恢复状态"状态，在这个状态下，Sentinel 会允许少量的调用请求通过，以探测资源是否已经恢复正常。

##### 5、自动恢复

如果在探测恢复状态状态下探测到资源调用已经恢复正常（比如调用成功率满足一定条件），Sentinel 会自动关闭熔断，恢复对该资源的正常调用，如果探测失败，则继续保持熔断状态。

## 50、Hystrix 是怎么设计熔断降级的？

Hystrix 是通过线程池的方式，来对依赖（**对应 Sentinel 中的资源**）进行了隔离。

##### 这样设计的好处是：

资源和资源之间做到了最彻底的隔离。

##### 这样设计的缺点是：

除了增加了线程切换的成本，还需要预先给各个资源做线程池大小的分配。

## 51、Sentinel 是如何处理系统负载过高的？

为了防止服务雪崩，系统负载保护机制是必须要做的。

当系统负载较高的时候，如果还持续让请求进入，可能会导致系统崩溃，服务无法响应。

在集群环境下，网络负载均衡组件（**比如：Nginx**）会把本应这台机器承载的流量转发到其它的机器上去，如果这个时候，其它的机器也处在一个即将满负荷状态的时候，这个增加的流量就会导致这台机器也崩溃，最后导致整个集群不可用。

Sentinel 提供了系统自适应保护机制：

- 保证系统不被拖垮
- 在系统稳定的前提下，保持系统的吞吐量

从整体维度对应用入口流量进行控制，**结合应用的 Load、总体平均 RT、入口 QPS 和线程数**等几个维度的监控指标，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。

## 52、Sentinel 都会产生哪些日志？

##### 1、拦截详情日志 (block 日志)

无论触发了限流、熔断降级还是系统保护，它们的秒级拦截详情日志都在以下日志文件中：

> ${user_home}/logs/csp/sentinel-block.log

##### 2、秒级监控日志

所有的资源访问都会产生秒级监控日志，日志文件默认为：

> ${user_home}/logs/csp/ {pid}-metrics.log

日志会随时间滚动。

##### 3、业务日志

其它的业务日志：

> ${user_home}/logs/csp/sentinel-record.log.xxx

该日志包含规则的推送、接收、处理等记录，排查问题的时候会非常有帮助。

##### 4、集群限流日志

集群限流日志：

> ${log_dir}/sentinel-cluster-client.log

会记录请求失败的信息。

##### 5、SPI 扩展机制

从 Sentinel 1.7.2 版本开始，Sentinel 支持 Logger 扩展机制，可以实现自定义的 Logger SPl 来将 record log 等日志自行处理。

## 53、Sentinel 支持实时监控吗？

Sentinel 提供对所有资源的实时监控，如果需要实时监控，客户端需引 l 入以下依赖：

```xml
<dependency>
    <groupid>com.alibaba.csp</groupid>
    <artifactid>sentinel-transport-simple-http</artifactid>
    <version>x.y.z</version>
</dependency>
```

引引入上述依赖后，客户端便会主动连接 Sentinel 控制台，通过 Sentinel 控制台即可查看客户端的实时监控。

## 54、Sentinel 监控数据能保留多久？

Sentinel 对监控数据的做法是定时落盘在客户端，然后 Sentinel 提供接口去拉取日志文件。

所以 Sentinel 在监控数据上理论上是**最少存储 1 天以上的数据**，然而作为控制台展示，则仅在内存中**聚合 5 分钟以内**的统计数据，不进行持久化。Sentinel 推荐大家对 Dashboard 进行改造实现指标信息的持久化，并从其它的存储中（如 RDBMS、时序数据库等）拉取的监控信息，包括实时的和历史的数据。

## 55、Sentinel 控制台都有哪些功能？

Sentinel 控制台包含如下功能：

- **查看机器列表以及健康情况**：收集 Sentinel 客户端发送的心跳包，用于判断机器是否在线。
- **监控**：通过 Sentinel 客户端暴露的监控 APl，定期拉取并且聚合应用监控信息，最终可以实现秒级的实时监控。
- **规则管理和推送**：统一管理推送规则。
- **鉴权**：需要根据自己的实际情况进行定制。

## 56、Sentinel 控制台支持的部署方式？

Sentinel 控制台目前仅支持单机部署。

## 57、Sentinel 控制台怎么做鉴权？

从 Sentinel 1.5.0 开始，Sentinel 控制台提供通用的鉴权接口 AuthService，用户可根据需求自行实现。

从 Sentinel 1.6.0 起，Sentinel 控制台引 l 入基本的登录功能：

![](/images/Sentinel/57.jpg)

默认用户名和密码都是`sentinel`，可以通过启动控制台参数进行配置：

> -Dsentinel.dashboard.auth.username=sentinel
>
> -Dsentinel.dashboard.auth.password=123456

或者直接在 Spring 项目中的 properties 文件中进行配置。

## 58、Sentinel 控制台有登录或细粒度的权限控制吗？

目前是没有的，权限控制功能需要自己去定制。

## 59、Sentinel 控制台的运行状况如何监控？

Sentinel 控制台目前只能单机部署，所以监控运行状况很重要。

##### 1、脚本检查状态

可以通过脚本定时检查服务进程，或通过系统服务管理工具实现。

##### 2、集成外部监控工具

将 Sentinel 控制台集成到现有的主流监控系统中，如 Prometheus、Grafana 等，这些监控工具可以提供实时的监控数据可视化和告警功能。

## 60、Sentinel 控制台无法连接客户端的常见原因有哪些？

Sentinel 控制台无法连接客户端的情况比较常见，可能的原因包括以下几点：

##### 1、网络问题

控制台和客户端之间的网络不通，比如 IP 地址或端口配置错误、网络防火墙设置、客户端和控制台不在同一网络等。

##### 2、客户端配置问题

客户端没有正确配置控制台地址，或配置的控制台地址错误。

##### 3、服务端（控制台）问题

- Sentinel 控制台未正常启动，或者控制台服务存在问题。
- 控制台配置的端口被占用或者控制台因为某些原因没有正常监听端口。

##### 4、版本不兼容

户端和控制台的 Sentinel 版本不兼容。

##### 5、资源限制

系统资源限制（如文件描述符限制、网络连接数限制等）导致新的连接无法建立。

##### 6、客户端启动顺序问题

有时候需要先启动 Sentinel 控制台，再启动客户端应用。

##### 7、日志和异常检查

客户端或控制台的日志中可能包含无法连接的具体错误信息或异常堆栈，这些信息对于诊断问题非常有用。

## 61、Sentinel 的指标怎么查看？

在 1.8.7 之前的版本中，Sentinel 的指标只能够通过「**日志**」或者「**控制台**」中查看，这样存在诸多弊端。

在 1.8.7 版本中，Sentinel 支持对接云原生时代下流行的可观测组件：**Prometheus**，通过扩展的方式将指标暴露给 Prometheus，效果如下：

![](/images/Sentinel/61.jpg)

## 62、如果应用已退出，Sentinel 控制台的应用列表还会显示吗？

会显示，如果应用已退出，超过 5 分钟都没有收到心跳，控制台就会标记对应机器为：**失联状态，但不会将对应应用从列表中移除。**

## 63、如在生产环境中使用 Sentinel 控制台，需要进行哪些改造？

在生产环境中使用 Sentinel 控制台需要考虑下面的问题：

##### 1、规则管理及推送

集中管理和推送规则。

sentinel-core 提供 API 和扩展接口来接收信息。开发者需要根据自己的环境，选取一个可靠的推送规则方式，同时，规则最好在控制台中集中管理。

##### 2、监控

支持可靠、快速的实时监控和历史监控数据查询。sentinel-core 记录秒级的资源运行情况，并且提供 API 来拉取资源运行信息。当机器大于一台以上的时候，可以通过 Dashboard 来拉取，聚合，并且存储这些信息。这个时候，Dashboard 需要有一个存储媒介，来存储历史运行情况。

##### 3、权限控制

区分用户角色，来进行操作。生产环境下的权限控制是非常重要的，理论上只有管理员等高级用户才有权限去修改应用的规则。

## 64、如何从 Hystrix 迁移到 Sentinel，说说方案？

从 Hystrix 迁移到 Sentinel 的方案：

| Hystrix 功能          | 迁移方案                                                                                                                                |
| --------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| 线程池隔离/信号量隔离 | Sentinel 不支持线程池隔离，信号量隔离对应 Sentinel 中的线程数限流。                                                                     |
| 熔断器                | Sentinel 支持按平均响应时间、异常比率、异常数来进行熔断降级。                                                                           |
| Command 创建          | 直接使用 Sentinel `Sphu` API 定义资源即可，资源定义与规则配置分离。                                                                     |
| 规则配置              | 在 Sentinel 中可通过 API 硬编码配置规则，也支持多种动态规则源。                                                                         |
| 注解支持              | Sentinel 也提供注解支持，可以很方便地迁移。                                                                                             |
| 开源框架支持          | Sentinel 提供 Servlet、Dubbo、Spring Cloud、gRPC 的适配模块，开箱即用；若之前使用 Spring Cloud Netflix，可迁移至 Spring Cloud Alibaba。 |

## 65、Sentinel 支持分布式链路跟踪吗？

不支持，未来也不可能会支持。

Sentinel 是服务架构中的流量治理组件，它的核心功能是**流量控制和限流降级**，所以，分布式链路跟踪并不是 Sentinel 应该关注的功能，可以参考其它分布式链路调用跟踪系统。

## 66、Sentinel 在分布式事务应用中有哪些注意点？

在分布式事务中应用 Sentinel 需要注意以下几个关键点：

##### 1、资源隔离与事务一致性

Sentinel 主要用于流量控制和熔断，这可能与分布式事务的一致性要求产生冲突。确保在应用流量控制和熔断策略时，不会破坏事务的一致性。

在事务关键路径上谨慎使用熔断策略，以避免因熔断导致的事务回滚或不一致问题。在使用诸如 Seata 等分布式事务解决方案时，需确保 Sentinel 的流控策略不会影响全局事务的正常管理。

##### 2、超时设置的协调

分布式事务中各服务的超时时间设置应与 Sentinel 的流量控制规则协调一致，确保不会因为流量控制导致事务超时。

##### 3、补偿机制的设计

在分布式事务中，如果因为流量限制导致部分服务不可用，需要设计相应的补偿机制来处理这些异常情况。

##### 4、事务回滚策略

设计明确的事务回滚策略，以应对流量控制或熔断时可能发生的事务中断。
