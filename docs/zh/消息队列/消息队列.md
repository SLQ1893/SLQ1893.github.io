## 1、消息队列有什么用？

MQ 全称为 Message Queue，即消息队列（MQ），它是一种应用程序对应用程序的通信方法，通过 MQ 实现的松耦合架构设计可以提高系统可用性以及可扩展性，是适用于现代应用的最佳设计方案。

消息传递指的是程序之间通过在消息中发送数据进行通信，而不是通过直接调用彼此来通信，直接调用通常是用于诸如远程过程调用的技术。

排队指的是应用程序通过队列来通信，队列的使用除去了接收和发送应用程序同时执行的要求。

## 2、消息队列有哪些应用场景？

消息队列比较核心的应用场景：**解耦、异步和削峰**。

## 3、消息队列有什么优缺点？

**优点：**

异步、解耦、削峰

**缺点：**

会给系统带来可用性、复杂性、一致性等问题，比如要考虑消息重复消费、消息丢失、顺序消费等问题。

## 4、消息队列怎么选型？

主流开源的消息中间件有：Kafka、ActiveMQ、RabbitMQ、RocketMQ。

下面是对比，仅供参考：

| 对比内容       |           RabbitMQ           |      ActiveMQ      |  RocketMQ  |       Kafka        |
| -------------- | :--------------------------: | :----------------: | :--------: | :----------------: |
| 所属机构/公司  |          GoPivotal           |       Apache       |  Alibaba   |       Apache       |
| 是否开源       |             开源             |        开源        |    开源    |        开源        |
| 技术文档完备   |              高              |         高         |     高     |         高         |
| 快速入门       |             提供             |        提供        |    提供    |        提供        |
| 成熟度         |             成熟             |        成熟        |    成熟    |        成熟        |
| 数据可靠性     |             可靠             |        可靠        |    可靠    |        可靠        |
| 集群           |             支持             |        支持        |    支持    |        支持        |
| 负载均衡       |             支持             |        支持        |    支持    |        支持        |
| 部署方式       |             独立             |        独立        |    独立    |        独立        |
| 开发语言       |            ErLang            |        Java        |    Java    |   Scala && Java    |
| 批量操作       |            不支持            |        支持        |    支持    |        支持        |
| 有序性支持     |         单客户端有序         |        支持        |    支持    |        支持        |
| 管理界面       |             较好             |        一般        | 命令行界面 |     命令行界面     |
| 消息延时       |            微秒级            |       微秒级       |   毫秒级   |       毫秒级       |
| 事务支持       |            不支持            |        支持        |    支持    |       不支持       |
| 客户端支持语言 |             多种             |        多种        |    Java    |        多种        |
| 社区活跃度     |              高              |         高         |     中     |         高         |
| 商业支持       |              无              |         无         |   阿里云   |         无         |
| 协议支持       |         AMQP 等多种          |    AMQP 等多种     | 自定义协议 |   自有协议，HTTP   |
| 消息丢失概率   |              低              |         低         |     无     |         无         |
| 可用性         |             主从             |        主从        |   分布式   |       分布式       |
| 单机吞吐量     |             万级             |        万级        |   十万级   |       十万级       |
| 部署难度       |              低              |         低         |     低     |         中         |
| 持久化         | 内存、文件，数据堆积影响效率 | 内存、文件、数据库 |    磁盘    | 磁盘，无限数据堆积 |
| 推拉方式       |          push/pull           |     push/pull      | push/pull  |     push/pull      |

## 5、有了多线程，为什么还要消息队列？

##### （1）业务解耦

使用多线程，所有业务代码都混在一起，耦合性太强，消息队列可以很方便进行解耦。

##### （2）扩展限制

使用多线程，资源消耗还是在本机器上，而消息队列可以转移到消费者的服务器上，可以很方便进行扩展。

##### （3）语言限制

多线程限定在具体的编程语言，解决的是编程层面的问题，而消息队列不限定编程语言，解决的是架构层面的问题。

消息队列的优势远不止上面三点。

## 6、消息队列和多线程应该怎么选择呢？

##### 考虑使用多线程：

1、可靠性要求不高；

2、不会过多占用资源；

3、不一定要进行解耦；

4、简单的异步任务；

##### 考虑使用消息队列：

1、可靠性要求较高；

2、不着急知道结果；

3、对架构进行解耦；

4、过多占用系统资源；

仅供参考，一句话总结就是，消息队列更适合复杂的系统架构，要求可靠性，能应对高并发，有灵活扩展性，如果简单的系统，不考虑其他，多线程就可以搞定。

## 7、使用消息队列会遇到哪些问题？

1、消息丢失；

2、消息重复消费；

3、消息积压；

4、消息顺序；

5、消息事务；

等等。。

## 8、消息队列为什么会产生消息重复消费？

MQ 中的消息被成功消费后，消费者都会发送一个成功消费标志给 MQ，MQ 收到成功标志就表示消息已经成功消费了，但是如果由于网络问题成功标志没有被成功送到 MQ，MQ 就认为这个消息没有被成功消费，就会再次发送给其他消费者，这不就造成了消息重复消费了。

## 9、消息队列如何处理消息重复消费问题？

解决这个问题，就要保证消费端的**幂等性**，即同样的参数多次重复的请求操作，其产生的结果应该是一样的，这样即使有重复消息业务也不会重复消费。

## 10、消息队列为什么会产生消息丢失？

##### 1、消息队列丢失数据

MQ 本身可能也会丢失消息，一般开启 MQ 的持久化到磁盘配置就能解决这个问题。

##### 2、生产者丢失数据

生产者往 MQ 发送消息的时候可能因为网络或者异常原因导致消息丢失了，其实主流的 MQ 都支持消息确认机制或消息事务机制，开启即可确保生产者将消息准确送到 MQ。

##### 3、消费者丢失数据

一般是因为消费者采用了消息自动确认模式，当 MQ 收到确认消息后会删除消息，如果这时消费者发生异常了，那消息也没了，但业务还没处理完成，修改为消息手动确认模式就能解决这个问题。

## 11、消息队列为什么需要顺序消息？

电商的下单操作就是一个顺序消息的场景：

（1）下单后先减库存

（2）然后再生成订单

如果这两个操作是由两个服务完成，就可能是两个消息，此时就需要保证消息按业务顺序执行，不然可能出现库存不足等问题。

## 12、消息队列如何保证消息顺序消费？

具体操作流程如下：

（1）MQ 生产者需要保证消息入队的顺序；

（2）一般的 MQ 都能保证内部队列是先进先出的，但只是针对一个队列，所以我们可以通过 Hash 取模的方式将同一个操作的所有消息发送到同一个队列里面，这样就能保证消息出队时也是顺序的了；

（3）消费者也需要注意，不能多个消费者同时消费一个队列，不然也会出现顺序错乱的情况。

## 13、消息延迟推送有哪些应用场景？

常见的互联网应用都有消息的延迟推送的场景，例如：

##### 1、电商七天后自动确认收货

我们签收快递后，物流系统会立即发送一个延时消息给支付系统，通知支付系统延迟七天后自动确认收费，并打款给商家，这个过程会持续七天。

##### 2、12306 自动取消未支付订单

我们都知道，购票订单在 30 分钟内不支付的话会被自动取消，其实在下完购票订单后，系统就会发送一个延时消息给订单系统，通知订单系统延时 30 分钟取消订单，如果我们在 30 分钟内支付了，则可以忽略收到的消息。

## 14、消息队列有哪两种常见的模式？

##### 主要分为以下两种模式：

1、推模式（push）

2、拉模式（pull）

## 15、什么是推模式？

> 我们在谈论推拉模式的时候，一般指的是消费者（Consumer）和服务端（Broker）之间的交互。
>
> 生产者（Producer）与服务端（Broker）之间都是使用推的方式，即 Producer 将消息推送给 Broker，而不是 Broker 主动去拉取消息。

推模式是由服务端（Broker）主动将消息送到消费者（Consumer），而不是由消费者自己去拉取。

## 16、什么是拉模式？

与推模式相反，拉模式是由消费者主动发起获取信息的。

在拉模式中， 消息不是主动推送给消息消费者的，而是要由消息消费者从队列中主动请求获取的，如果没有消费者监听队列，消息将保留在队列中，直至消息消费者连接到队列为止。

## 17、推模式有什么优缺点？

##### 推模式的主要优点：

1、消息实时性强，能及时向客户端推送最新的消息

##### 推模式的缺点：

1、不能确保发送成功

推模式采用的是广播方式，只有服务端和客户端在同一个频道上推模式才能发送成功。

2、不能跟踪发送状态

推模式采用了开环控制技术，消息推送后的状态无从得知，并且推送的消息可能不满足客户端的需求，针对性较差。

## 18、拉模式有什么优缺点？

##### 拉模式的主要优点：

1、针对性较强，能满足客户端的个性化需求；

2、服务器端压力小，服务器端只是被动接收请求；

##### 拉模式的缺点：

1、实时性较差，无法及时收到服务器端实时更新的消息；

## 19、什么是消息持久化？

消息持久化是把消息保存到物理介质上，以防止消息的丢失。

## 20、消息持久化有什么缺点？

消息持久化的缺点是**很消耗性能**，因为写入硬盘要比写入内存的性能低很多，从而降低了消息队列服务器的吞吐量。

可以使用固态硬盘来提高读写速度，以优化消息持久化的速度。

## 21、什么是 JMS？

JMS，全称：**Java Messaging Service**，即：Java 消息服务，是 Java 平台上有关面向消息中间件的技术规范，用于在两个应用程序之间，或分布式系统中发送消息进行异步通信。

Java 消息服务是一个与具体平台无关的 API，绝大多数提供商都支持 JMS 规范，JMS 最主流的开源技术是 Apache ActiveMQ、RocketMQ。

## 22、JMS 支持哪几种消息模型？

**JMS 规范目前支持 2 种消息模型：**

1、点对点模式（不可重复消费）

2、发布/订阅模式（可以重复消费）
